# Milestone v1.0: Automatic Sliding Gate Control

**Status:** SHIPPED 2026-02-06
**Phases:** 1-4
**Total Plans:** 9

## Overview

TIA Portal v20 SCL code for an S7-1212C controlling an automatic sliding gate at a church. The journey moved from foundational block structure through isolated safety logic, then state machine implementation, culminating in timer integration and output mapping. Each phase built on the previous, with safety logic verified before control logic was added.

## Phases

### Phase 1: Foundation

**Goal**: Establish SCL block structure and configuration parameters for TIA Portal import
**Depends on**: Nothing (first phase)
**Plans**: 2 plans

Plans:
- [x] 01-01: Create DB_States and DB_Config data blocks
- [x] 01-02: Create FC_Veiligheid, FB_HekBesturing, FC_Outputs, Main_OB1

**Details:**
- State constants (0-8) matching FDS section 2.2 order
- Direction constants (DIR_NONE, DIR_OPEN, DIR_DICHT)
- Config parameters grouped in nested STRUCTs
- Call chain pattern: FC_Veiligheid -> FB_HekBesturing -> FC_Outputs
- Physical I/O only in OB1 (blocks use symbolic parameters)

**Completed:** 2026-02-03

### Phase 2: Safety Core

**Goal**: Implement safety trigger detection, debouncing, and priority logic
**Depends on**: Phase 1
**Plans**: 2 plans

Plans:
- [x] 02-01: Convert FC_Veiligheid to FB_Veiligheid with TON debouncing
- [x] 02-02: Implement priority logic (FAULT > PBV > VS) and SafetyStop output

**Details:**
- TON timers for debounce (PBV/FAULT 50ms, VS 100ms)
- Priority masking with AND NOT cascade
- Debug flags for raw debounced values
- Combined SafetyStop output for state machine

**Completed:** 2026-02-03

### Phase 3: State Machine

**Goal**: Implement 9-state machine with all transitions, control inputs, and safety behaviors
**Depends on**: Phase 2
**Plans**: 3 plans

Plans:
- [x] 03-01: Core structure, initialization, HOMING, IDLE, FAULT states
- [x] 03-02: Control inputs, MOVING states, STOPPED, direction memory
- [x] 03-03: VS_PAUSE, PBV_RETRACT, timeout integration, output assignments

**Details:**
- 9 states: HOMING, IDLE_OPEN, IDLE_DICHT, MOVING_OPEN, MOVING_DICHT, STOPPED, VS_PAUSE, PBV_RETRACT, FAULT
- Key switch rising edge detection, push button falling edge
- Direction memory for resume functionality
- PBV always retracts toward OPEN (safe direction)
- VS saves and restores direction on resume

**Completed:** 2026-02-03

### Phase 4: Integration

**Goal**: Complete system with timer sequences, output mapping, and full OB1 orchestration
**Depends on**: Phase 3
**Plans**: 2 plans

Plans:
- [x] 04-01: Timer infrastructure and low speed logic (TONR timers, direction change detection)
- [x] 04-02: VS resume delay, PBV pause timer, FC_Outputs mutual exclusion

**Details:**
- TONR for pausable low speed timers
- Two low speed timers: 5s startup, 2s VS resume
- PBV two-phase: 500ms pause then timed retract
- VS resume delay before movement continues
- Motor mutual exclusion in FC_Outputs (defense in depth)

**Completed:** 2026-02-06

---

## Milestone Summary

**Key Decisions:**

| Decision | Rationale | Outcome |
|----------|-----------|---------|
| SCL external source files | Human-readable, direct TIA Portal import | Good |
| statemachine.mmd as canonical | Single source for state transitions | Good |
| PBV always retracts toward OPEN | Bumper on closing edge, safest direction | Good |
| Timer pauses on stops | Position unknown during stop, timer measures movement only | Good |
| Automatic FAULT recovery | No manual reset needed, recovers when sensors valid | Good |
| Priority masking with AND NOT | Clear diagnostic hierarchy, no double-counting | Good |
| TONR for pausable timers | Built-in pause/resume, reset via R | Good |
| PBV pause before retract | Obstacle detection time before motor starts | Good |
| Motor mutual exclusion in FC | Defense in depth, catches FB logic bugs | Good |

**Issues Resolved:**
- Phase 2 scope narrowed (timer integration moved to Phase 4) for cleaner separation
- VS immediate resume in Phase 3 replaced with configurable delay in Phase 4

**Issues Deferred:**
- TIA Portal XML export format (SCL sufficient for import)

**Technical Debt Incurred:**
- None - all requirements implemented cleanly

---

*For current project status, see .planning/MILESTONES.md*

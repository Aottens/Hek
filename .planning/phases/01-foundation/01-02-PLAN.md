---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - PLC/Sources/03_FC_Veiligheid.scl
  - PLC/Sources/04_FB_HekBesturing.scl
  - PLC/Sources/05_DB_HekData.scl
  - PLC/Sources/06_FC_Outputs.scl
  - PLC/Sources/07_Main_OB1.scl
autonomous: true

must_haves:
  truths:
    - "OB1 calls blocks in order: FC_Veiligheid -> FB_HekBesturing -> FC_Outputs"
    - "FB_HekBesturing has VAR section with m_Toestand for state machine"
    - "FB_HekBesturing has instance DB (DB_HekData)"
    - "FC_Veiligheid stub has inputs for all safety sensors"
    - "FC_Outputs stub has outputs for motor and alarm"
  artifacts:
    - path: "PLC/Sources/03_FC_Veiligheid.scl"
      provides: "Safety processing function stub"
      contains: "FUNCTION.*FC_Veiligheid"
    - path: "PLC/Sources/04_FB_HekBesturing.scl"
      provides: "State machine function block stub"
      contains: "FUNCTION_BLOCK.*FB_HekBesturing"
    - path: "PLC/Sources/05_DB_HekData.scl"
      provides: "Instance DB for FB_HekBesturing"
      contains: "FB_HekBesturing"
    - path: "PLC/Sources/06_FC_Outputs.scl"
      provides: "Output mapping function stub"
      contains: "FUNCTION.*FC_Outputs"
    - path: "PLC/Sources/07_Main_OB1.scl"
      provides: "Main program cycle"
      contains: "ORGANIZATION_BLOCK.*Main"
  key_links:
    - from: "07_Main_OB1.scl"
      to: "FC_Veiligheid, FB_HekBesturing, FC_Outputs"
      via: "Block calls in sequence"
      pattern: "FC_Veiligheid.*FB_HekBesturing.*FC_Outputs"
    - from: "05_DB_HekData.scl"
      to: "04_FB_HekBesturing.scl"
      via: "Instance DB reference"
      pattern: "FB_HekBesturing"
---

<objective>
Create function blocks, safety function, output function, and main program with proper call structure.

Purpose: Establish the complete block call chain (OB1 -> FC_Veiligheid -> FB_HekBesturing -> FC_Outputs) with stub implementations. This validates the block structure compiles and sets up the scaffolding for Phase 2-4 implementation.

Output: Five SCL files ready for TIA Portal v20 import that compile and establish the correct call hierarchy per CODE-01.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01-foundation/01-RESEARCH.md (SCL syntax reference)
@.planning/phases/01-foundation/01-CONTEXT.md (implementation decisions)
@.planning/REQUIREMENTS.md (CODE-01 through CODE-04, CODE-06)
@FDS-Automatisch-Hek-v0.2.md (I/O specification, program structure)
@IO-LIJST.md (I/O addresses and descriptions)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FC_Veiligheid, FB_HekBesturing, and DB_HekData</name>
  <files>
    PLC/Sources/03_FC_Veiligheid.scl
    PLC/Sources/04_FB_HekBesturing.scl
    PLC/Sources/05_DB_HekData.scl
  </files>
  <action>
**Create `PLC/Sources/03_FC_Veiligheid.scl`** (safety function stub):

1. Header comment: "Veiligheidsverwerking voor automatisch hek"
2. FUNCTION declaration:
   - Name: "FC_Veiligheid"
   - Return: Void
   - Attribute: { S7_Optimized_Access := 'TRUE' }
   - VERSION : 0.1

3. VAR_INPUT section (all safety-related inputs from IO-LIJST):
   - i_PBV_BeweegbaarHek : Bool;  // Rubber bumper (NC: 0=OK, 1=trigger)
   - i_VS_Voertuig : Bool;        // Beam detectie (0=onderbroken)
   - i_BNS_Open : Bool;           // Eindstand OPEN (NC: 0=bereikt)
   - i_BNS_Dicht : Bool;          // Eindstand DICHT (NC: 0=bereikt)

4. VAR_OUTPUT section:
   - q_PBV_Trigger : Bool;        // PBV geactiveerd (gedebounced)
   - q_VS_Trigger : Bool;         // VS geactiveerd (gedebounced)
   - q_Fault : Bool;              // Sensordefect gedetecteerd

5. VAR_TEMP section:
   - t_BeidEindstanden : Bool;    // Hulpvariabele

6. BEGIN section with stub implementation:
   - Set all outputs to FALSE
   - Comment: // Volledige implementatie in Phase 2

---

**Create `PLC/Sources/04_FB_HekBesturing.scl`** (state machine FB stub):

1. Header comment: "Toestandsmachine voor hekbesturing - 9 toestanden per FDS"
2. FUNCTION_BLOCK declaration:
   - Name: "FB_HekBesturing"
   - Attribute: { S7_Optimized_Access := 'TRUE' }
   - VERSION : 0.1

3. VAR_INPUT section (control + safety inputs):
   - i_SS_Open : Bool;            // Sleutel naar OPEN
   - i_SS_Dicht : Bool;           // Sleutel naar DICHT
   - i_DK_Bediening : Bool;       // Drukknop (NC: 0=ingedrukt)
   - i_BNS_Open : Bool;           // Eindstand OPEN
   - i_BNS_Dicht : Bool;          // Eindstand DICHT
   - i_PBV_Trigger : Bool;        // PBV actief (van FC_Veiligheid)
   - i_VS_Trigger : Bool;         // VS actief (van FC_Veiligheid)
   - i_Fault : Bool;              // Sensordefect (van FC_Veiligheid)

4. VAR_OUTPUT section:
   - q_MS_Open : Bool;            // Motor richting OPEN
   - q_MS_Dicht : Bool;           // Motor richting DICHT
   - q_MS_LaagToeren : Bool;      // Lage snelheid actief
   - q_AlarmKerk : Bool;          // Kerkalarm (0=AAN, fail-safe)
   - q_HuidigeToestand : Int;     // Huidige toestand voor diagnose

5. VAR section (static, retained between calls):
   - m_Toestand : Int;            // Huidige toestand
   - m_VorigeToestand : Int;      // Vorige toestand
   - m_LaatsteRichting : Int;     // Laatst actieve richting (DIR_OPEN/DIR_DICHT)

6. BEGIN section with stub implementation:
   - Initialize all outputs to FALSE
   - Set q_AlarmKerk := TRUE (fail-safe: hek niet dicht)
   - Set q_HuidigeToestand := m_Toestand
   - Comment: // Volledige state machine implementatie in Phase 3

---

**Create `PLC/Sources/05_DB_HekData.scl`** (instance DB for FB):

1. Header comment: "Instance datablock voor FB_HekBesturing"
2. DATA_BLOCK declaration:
   - Name: "DB_HekData"
   - Attribute: { S7_Optimized_Access := 'TRUE' }
   - VERSION : 0.1
   - NON_RETAIN

3. FB type reference (on separate line after name):
   - "FB_HekBesturing"

4. Empty BEGIN/END_DATA_BLOCK

Follow exact syntax from RESEARCH.md "Instance DATA_BLOCK for FB" section.
  </action>
  <verify>
Files exist and contain:
- FC_Veiligheid with 4 inputs, 3 outputs, Void return
- FB_HekBesturing with 8 inputs, 5 outputs, 3 static variables
- DB_HekData referencing FB_HekBesturing
- All have S7_Optimized_Access attribute
  </verify>
  <done>
FC_Veiligheid.scl, FB_HekBesturing.scl, and DB_HekData.scl exist with correct structure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FC_Outputs and Main_OB1 with call structure</name>
  <files>
    PLC/Sources/06_FC_Outputs.scl
    PLC/Sources/07_Main_OB1.scl
  </files>
  <action>
**Create `PLC/Sources/06_FC_Outputs.scl`** (output mapping function stub):

1. Header comment: "Output mapping op basis van toestand"
2. FUNCTION declaration:
   - Name: "FC_Outputs"
   - Return: Void
   - Attribute: { S7_Optimized_Access := 'TRUE' }
   - VERSION : 0.1

3. VAR_INPUT section (state and control signals):
   - i_HuidigeToestand : Int;     // Huidige toestand van FB_HekBesturing
   - i_MS_Open : Bool;            // Motor open commando
   - i_MS_Dicht : Bool;           // Motor dicht commando
   - i_MS_LaagToeren : Bool;      // Lage snelheid commando
   - i_AlarmKerk : Bool;          // Alarm commando

4. VAR_OUTPUT section (physical outputs):
   - q_MS_Open : Bool;            // %Q0.4 Motor richting OPEN
   - q_MS_Dicht : Bool;           // %Q0.5 Motor richting DICHT
   - q_MS_LaagToeren : Bool;      // %Q0.6 Motor lage snelheid
   - q_AlarmKerk : Bool;          // %Q0.3 Kerkalarm

5. BEGIN section with stub (direct pass-through):
   - q_MS_Open := i_MS_Open;
   - q_MS_Dicht := i_MS_Dicht;
   - q_MS_LaagToeren := i_MS_LaagToeren;
   - q_AlarmKerk := i_AlarmKerk;
   - Comment: // Volledige output logica in Phase 4

---

**Create `PLC/Sources/07_Main_OB1.scl`** (main program):

1. Header comment: "Hoofdprogramma - cyclische uitvoering"
2. ORGANIZATION_BLOCK declaration:
   - Name: "Main"
   - TITLE = Hoofdprogramma cyclus
   - Attribute: { S7_Optimized_Access := 'TRUE' }
   - VERSION : 0.1

3. VAR_TEMP section:
   - t_OB1_Info : Array[0..19] of Byte;  // OB1 systeeminformatie

4. BEGIN section with call structure per CODE-01:
   - Comment block explaining call order and purpose
   - Call "FC_Veiligheid"() with sensor inputs
   - Call "FB_HekBesturing"."DB_HekData"() with all inputs
   - Call "FC_Outputs"() with FB outputs

5. Block calls should use named parameters where practical, example:
```scl
// 1. Veiligheidsverwerking - prioriteit: FAULT > PBV > VS
"FC_Veiligheid"(
    i_PBV_BeweegbaarHek := %I1.2,
    i_VS_Voertuig := %I1.3,
    i_BNS_Open := %I0.7,
    i_BNS_Dicht := %I1.0,
    q_PBV_Trigger => ...,
    q_VS_Trigger => ...,
    q_Fault => ...
);
```

Note: Use intermediate variables or direct wiring as appropriate for TIA Portal. The key requirement is the call ORDER: FC_Veiligheid -> FB_HekBesturing -> FC_Outputs.
  </action>
  <verify>
Files exist and contain:
- FC_Outputs with state input and 4 physical outputs
- Main_OB1 with ORGANIZATION_BLOCK declaration
- Main_OB1 calls blocks in order: FC_Veiligheid, FB_HekBesturing.DB_HekData, FC_Outputs
- All have S7_Optimized_Access attribute
  </verify>
  <done>
FC_Outputs.scl and Main_OB1.scl exist with correct call structure per CODE-01.
  </done>
</task>

</tasks>

<verification>
Complete block structure ready for TIA Portal import:

1. **Compilation order verified** (per RESEARCH.md):
   - 01_DB_States.scl (global DB)
   - 02_DB_Config.scl (global DB)
   - 03_FC_Veiligheid.scl (FC)
   - 04_FB_HekBesturing.scl (FB)
   - 05_DB_HekData.scl (instance DB - after FB!)
   - 06_FC_Outputs.scl (FC)
   - 07_Main_OB1.scl (OB)

2. **Call structure verified** (CODE-01):
   - OB1 -> FC_Veiligheid (safety first)
   - OB1 -> FB_HekBesturing (state machine)
   - OB1 -> FC_Outputs (outputs last)

3. **Block dependencies correct**:
   - FB_HekBesturing has instance DB (DB_HekData)
   - All blocks reference inputs/outputs consistently
</verification>

<success_criteria>
- [ ] FC_Veiligheid.scl has all safety sensor inputs and trigger outputs
- [ ] FB_HekBesturing.scl has m_Toestand, m_VorigeToestand, m_LaatsteRichting
- [ ] DB_HekData.scl correctly references FB_HekBesturing
- [ ] FC_Outputs.scl maps internal signals to physical outputs
- [ ] Main_OB1.scl calls FC_Veiligheid -> FB_HekBesturing -> FC_Outputs in order
- [ ] All 7 SCL files exist in PLC/Sources/ with numbered prefixes
- [ ] Phase 1 requirements CODE-01 through CODE-06 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>

---
phase: 03-state-machine
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - PLC/Sources/04_FB_HekBesturing.scl
autonomous: true

must_haves:
  truths:
    - "Key switch OPEN from IDLE_DICHT starts movement toward OPEN"
    - "Key switch DICHT from IDLE_OPEN starts movement toward DICHT"
    - "Push button during movement transitions to STOPPED"
    - "Push button from STOPPED resumes last active direction"
    - "Key switch from STOPPED starts in selected direction (overrides last)"
    - "Opposing key direction during movement stops the gate"
    - "Movement reaching endstop transitions to corresponding IDLE state"
    - "Movement timeout (90s) transitions to STOPPED"
  artifacts:
    - path: "PLC/Sources/04_FB_HekBesturing.scl"
      provides: "MOVING_OPEN, MOVING_DICHT, STOPPED states with control logic"
      contains: "STATE_MOVING_OPEN"
  key_links:
    - from: "FB_HekBesturing STOPPED"
      to: "m_LaatsteRichting"
      via: "Push button resume direction"
      pattern: "#m_LaatsteRichting = \"DB_States\"\\.DIR_OPEN"
    - from: "FB_HekBesturing MOVING"
      to: "Edge detection"
      via: "Key switch and push button edges"
      pattern: "#m_EdgeSS_Open\\.Q|#m_EdgeDK\\.Q"
---

<objective>
Implement movement states (MOVING_OPEN, MOVING_DICHT) and STOPPED state with complete control input handling including key switch edge detection, push button toggle, direction memory, and CTL-07/CTL-08 requirements.

Purpose: Enable normal gate operation - key switch commands, push button stop/resume, direction memory for toggle behavior.

Output: FB_HekBesturing.scl with MOVING_OPEN, MOVING_DICHT, and STOPPED states fully implemented with all CTL requirements.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-state-machine/03-CONTEXT.md
@.planning/phases/03-state-machine/03-RESEARCH.md
@.planning/phases/03-state-machine/03-01-SUMMARY.md

# Current source files
@PLC/Sources/04_FB_HekBesturing.scl
@PLC/Sources/01_DB_States.scl
@statemachine.mmd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement MOVING_OPEN state with all transitions</name>
  <files>PLC/Sources/04_FB_HekBesturing.scl</files>
  <action>
Replace the placeholder for STATE_MOVING_OPEN in the CASE statement:

```scl
"DB_States".STATE_MOVING_OPEN:
    // Moving toward OPEN position
    // Safety checks FIRST (priority: FAULT > PBV > VS)
    IF #i_Fault THEN
        #m_Toestand := "DB_States".STATE_FAULT;
    ELSIF #i_PBV_Trigger THEN
        // PBV during OPEN movement -> retract (continues toward OPEN)
        #m_Toestand := "DB_States".STATE_PBV_RETRACT;
    ELSIF #i_VS_Trigger THEN
        // VS pause - save direction for auto-resume
        #m_VorigeRichtingVoorVS := "DB_States".DIR_OPEN;
        #m_Toestand := "DB_States".STATE_VS_PAUSE;
    ELSIF #m_TON_Timeout.Q THEN
        // SAF-11: Movement timeout -> STOPPED
        #m_Toestand := "DB_States".STATE_STOPPED;
        #m_KeyReleased := FALSE;  // CTL-08: require key release
    ELSIF NOT #i_BNS_Open THEN
        // NC: 0 = reached OPEN endstop
        #m_Toestand := "DB_States".STATE_IDLE_OPEN;
    ELSIF #m_EdgeDK.Q THEN
        // Push button -> manual stop
        #m_Toestand := "DB_States".STATE_STOPPED;
    ELSIF #m_EdgeSS_Dicht.Q THEN
        // CTL-07: Opposing key direction while moving -> stop
        #m_Toestand := "DB_States".STATE_STOPPED;
    END_IF;
    // Direction memory maintained (already set when entering this state)
    // Motor output: q_MS_Open=TRUE (handled in output section)
```

The order of checks matches priority: FAULT > PBV > VS > timeout > endstop > user input.
CTL-07 is implemented by checking opposing key edge and transitioning to STOPPED.
  </action>
  <verify>STATE_MOVING_OPEN handles: FAULT->FAULT, PBV->PBV_RETRACT, VS->VS_PAUSE, timeout->STOPPED, endstop->IDLE_OPEN, push button->STOPPED, opposing key->STOPPED</verify>
  <done>MOVING_OPEN state complete with all safety transitions, endstop detection, push button stop, and opposing key stop (CTL-07)</done>
</task>

<task type="auto">
  <name>Task 2: Implement MOVING_DICHT state with all transitions</name>
  <files>PLC/Sources/04_FB_HekBesturing.scl</files>
  <action>
Replace the placeholder for STATE_MOVING_DICHT in the CASE statement:

```scl
"DB_States".STATE_MOVING_DICHT:
    // Moving toward DICHT (closed) position
    // Safety checks FIRST (priority: FAULT > PBV > VS)
    IF #i_Fault THEN
        #m_Toestand := "DB_States".STATE_FAULT;
    ELSIF #i_PBV_Trigger THEN
        // PBV during DICHT movement -> retract toward OPEN (SAF-03)
        #m_Toestand := "DB_States".STATE_PBV_RETRACT;
    ELSIF #i_VS_Trigger THEN
        // VS pause - save direction for auto-resume
        #m_VorigeRichtingVoorVS := "DB_States".DIR_DICHT;
        #m_Toestand := "DB_States".STATE_VS_PAUSE;
    ELSIF #m_TON_Timeout.Q THEN
        // SAF-11: Movement timeout -> STOPPED
        #m_Toestand := "DB_States".STATE_STOPPED;
        #m_KeyReleased := FALSE;  // CTL-08: require key release
    ELSIF NOT #i_BNS_Dicht THEN
        // NC: 0 = reached DICHT endstop
        #m_Toestand := "DB_States".STATE_IDLE_DICHT;
    ELSIF #m_EdgeDK.Q THEN
        // Push button -> manual stop
        #m_Toestand := "DB_States".STATE_STOPPED;
    ELSIF #m_EdgeSS_Open.Q THEN
        // CTL-07: Opposing key direction while moving -> stop
        #m_Toestand := "DB_States".STATE_STOPPED;
    END_IF;
    // Direction memory maintained (already set when entering this state)
    // Motor output: q_MS_Dicht=TRUE (handled in output section)
```

Mirrors MOVING_OPEN structure but checks opposite endstop and opposite key for CTL-07.
  </action>
  <verify>STATE_MOVING_DICHT handles: FAULT->FAULT, PBV->PBV_RETRACT, VS->VS_PAUSE, timeout->STOPPED, endstop->IDLE_DICHT, push button->STOPPED, opposing key->STOPPED</verify>
  <done>MOVING_DICHT state complete with all safety transitions, endstop detection, push button stop, and opposing key stop (CTL-07)</done>
</task>

<task type="auto">
  <name>Task 3: Implement STOPPED state with resume logic and CTL-08</name>
  <files>PLC/Sources/04_FB_HekBesturing.scl</files>
  <action>
Replace the placeholder for STATE_STOPPED in the CASE statement:

```scl
"DB_States".STATE_STOPPED:
    // Stopped in intermediate position (not at endstop)
    // Motor outputs off (handled in output section)

    IF #i_Fault THEN
        #m_Toestand := "DB_States".STATE_FAULT;
    ELSE
        // CTL-08: Track key release after timeout
        // Keys must be released before new input is accepted
        IF NOT #m_KeyReleased THEN
            // Waiting for key release after timeout
            IF NOT #i_SS_Open AND NOT #i_SS_Dicht THEN
                #m_KeyReleased := TRUE;
            END_IF;
            // Ignore all input while waiting for release
        ELSE
            // Normal input processing
            // CTL-06: Key switch from STOPPED starts in selected direction (overrides last direction)
            IF #m_EdgeSS_Open.Q THEN
                #m_Toestand := "DB_States".STATE_MOVING_OPEN;
                #m_LaatsteRichting := "DB_States".DIR_OPEN;
            ELSIF #m_EdgeSS_Dicht.Q THEN
                #m_Toestand := "DB_States".STATE_MOVING_DICHT;
                #m_LaatsteRichting := "DB_States".DIR_DICHT;
            // CTL-04, CTL-05: Push button toggles stop/resume, resumes last direction
            ELSIF #m_EdgeDK.Q THEN
                IF #m_LaatsteRichting = "DB_States".DIR_OPEN THEN
                    #m_Toestand := "DB_States".STATE_MOVING_OPEN;
                ELSIF #m_LaatsteRichting = "DB_States".DIR_DICHT THEN
                    #m_Toestand := "DB_States".STATE_MOVING_DICHT;
                END_IF;
                // If m_LaatsteRichting = DIR_NONE (fresh power-up, never moved)
                // -> ignore push button (safest default per CONTEXT.md - no movement without explicit direction)
            END_IF;
        END_IF;
    END_IF;
```

Key behaviors:
- CTL-05: Push button resumes m_LaatsteRichting (if not DIR_NONE)
- CTL-06: Key switch overrides last direction and starts movement
- CTL-08: After timeout, m_KeyReleased=FALSE requires both keys released before accepting input
- Push button with no direction memory (DIR_NONE) is ignored (safety)
  </action>
  <verify>STATE_STOPPED handles: FAULT->FAULT, key release tracking (CTL-08), key switch->MOVING with direction set, push button->MOVING if direction known</verify>
  <done>STOPPED state complete with key release tracking (CTL-08), key switch start (CTL-06), push button resume (CTL-04, CTL-05)</done>
</task>

</tasks>

<verification>
After all tasks complete, verify the following behaviors through code review:

1. **Movement to endstop:**
   - MOVING_OPEN + i_BNS_Open=0 -> IDLE_OPEN
   - MOVING_DICHT + i_BNS_Dicht=0 -> IDLE_DICHT

2. **Push button stop/resume:**
   - MOVING_OPEN + push button edge -> STOPPED (m_LaatsteRichting remains DIR_OPEN)
   - STOPPED + push button edge -> MOVING_OPEN (because m_LaatsteRichting=DIR_OPEN)

3. **Key switch from STOPPED:**
   - STOPPED + key OPEN edge -> MOVING_OPEN (m_LaatsteRichting set to DIR_OPEN)
   - STOPPED + key DICHT edge -> MOVING_DICHT (m_LaatsteRichting set to DIR_DICHT)

4. **Opposing key (CTL-07):**
   - MOVING_OPEN + key DICHT edge -> STOPPED
   - MOVING_DICHT + key OPEN edge -> STOPPED

5. **Key release requirement (CTL-08):**
   - After timeout in MOVING_*, m_KeyReleased=FALSE
   - STOPPED ignores input until both i_SS_Open=0 AND i_SS_Dicht=0
   - After release, m_KeyReleased=TRUE and input accepted

6. **Safety priority in movement:**
   - MOVING_* + i_Fault -> FAULT
   - MOVING_* + i_PBV_Trigger -> PBV_RETRACT
   - MOVING_* + i_VS_Trigger -> VS_PAUSE
</verification>

<success_criteria>
- MOVING_OPEN and MOVING_DICHT states fully implemented
- STOPPED state with complete resume logic
- Direction memory (m_LaatsteRichting) set on key switch entry to MOVING states
- Direction memory preserved across push button stop
- CTL-07: Opposing key stops movement
- CTL-08: Key release tracking after timeout
- All safety checks (FAULT/PBV/VS) present in movement states
- Push button with no direction memory is safely ignored
</success_criteria>

<output>
After completion, create `.planning/phases/03-state-machine/03-02-SUMMARY.md`
</output>

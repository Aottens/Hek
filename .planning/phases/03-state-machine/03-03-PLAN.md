---
phase: 03-state-machine
plan: 03
type: execute
wave: 3
depends_on: [03-02]
files_modified:
  - PLC/Sources/04_FB_HekBesturing.scl
autonomous: true

must_haves:
  truths:
    - "PBV trigger during movement initiates retract toward OPEN"
    - "PBV retract ignores all operator input (key switch and push button)"
    - "PBV retract reaching OPEN endstop transitions to IDLE_OPEN"
    - "PBV retract timeout (without reaching endstop) transitions to STOPPED"
    - "VS trigger during movement pauses gate and saves direction"
    - "VS cleared auto-resumes in saved direction (no operator input needed)"
    - "VS ignores operator input during pause (SAF-09)"
    - "Motor outputs are correct for each state (OPEN, DICHT, or both off)"
  artifacts:
    - path: "PLC/Sources/04_FB_HekBesturing.scl"
      provides: "Complete state machine with VS_PAUSE, PBV_RETRACT, and output logic"
      contains: "STATE_VS_PAUSE"
  key_links:
    - from: "FB_HekBesturing PBV_RETRACT"
      to: "q_MS_Open output"
      via: "Always moves toward OPEN"
      pattern: "STATE_PBV_RETRACT.*q_MS_Open"
    - from: "FB_HekBesturing VS_PAUSE"
      to: "m_VorigeRichtingVoorVS"
      via: "Direction restore on resume"
      pattern: "#m_VorigeRichtingVoorVS"
---

<objective>
Implement VS_PAUSE and PBV_RETRACT safety response states with proper direction handling, operator input blocking, and timer-based transitions. Complete the state machine with final output assignment verification.

Purpose: Handle safety sensor responses correctly - VS pauses and auto-resumes, PBV retracts toward OPEN and ignores input. This completes the state machine for Phase 3.

Output: FB_HekBesturing.scl with all 9 states fully implemented and motor/alarm outputs correctly assigned.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-state-machine/03-CONTEXT.md
@.planning/phases/03-state-machine/03-RESEARCH.md
@.planning/phases/03-state-machine/03-01-SUMMARY.md
@.planning/phases/03-state-machine/03-02-SUMMARY.md

# Current source files
@PLC/Sources/04_FB_HekBesturing.scl
@PLC/Sources/01_DB_States.scl
@PLC/Sources/02_DB_Config.scl
@statemachine.mmd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PBV retract timer variable</name>
  <files>PLC/Sources/04_FB_HekBesturing.scl</files>
  <action>
Add a TON timer for PBV retract duration to the VAR section:

```scl
// In VAR section, add after m_TON_Timeout:
m_TON_PBV_Retract : TON;      // PBV retract duration timer (3s per CFG_PBV_TerugtrekMs)
```

Also add the timer call in the code BEFORE the CASE statement (next to the existing m_TON_Timeout call):

```scl
// PBV retract timer - runs only in PBV_RETRACT state
#m_TON_PBV_Retract(IN := (#m_Toestand = "DB_States".STATE_PBV_RETRACT),
                   PT := "DB_Config".Timers.CFG_PBV_TerugtrekMs);
```

Note: The VS resume timer (CFG_VS_HervattingMs) will be implemented in Phase 4 with the timer sequence work. For Phase 3, VS_PAUSE will transition immediately when VS clears (simplified behavior, enhanced in Phase 4).
  </action>
  <verify>VAR section contains m_TON_PBV_Retract : TON; timer call appears before CASE statement</verify>
  <done>PBV retract timer variable added and called before CASE statement</done>
</task>

<task type="auto">
  <name>Task 2: Implement PBV_RETRACT state</name>
  <files>PLC/Sources/04_FB_HekBesturing.scl</files>
  <action>
Replace the placeholder for STATE_PBV_RETRACT in the CASE statement:

```scl
"DB_States".STATE_PBV_RETRACT:
    // Retracting toward OPEN after bumper activation
    // SAF-03: Always moves toward OPEN regardless of previous direction
    // SAF-05: Ignores ALL operator input during retract
    // Motor output: q_MS_Open=TRUE (handled in output section)

    // Only FAULT can interrupt PBV_RETRACT (FAULT > PBV priority)
    IF #i_Fault THEN
        #m_Toestand := "DB_States".STATE_FAULT;
    ELSIF NOT #i_BNS_Open THEN
        // NC: 0 = reached OPEN endstop -> safest position achieved
        #m_Toestand := "DB_States".STATE_IDLE_OPEN;
    ELSIF #m_TON_PBV_Retract.Q THEN
        // SAF-04: Max retract duration reached, still in mid-position
        #m_Toestand := "DB_States".STATE_STOPPED;
        // Clear direction memory - operator must choose new direction
        #m_LaatsteRichting := "DB_States".DIR_NONE;
    END_IF;
    // NOTE: Push button and key switch edges are IGNORED in this state (SAF-05)
    // They are still detected (edge triggers run before CASE) but not acted upon
```

Key behaviors per requirements:
- SAF-03: Motor always toward OPEN (output section handles this)
- SAF-04: Timer limits retract duration (CFG_PBV_TerugtrekMs = 3s)
- SAF-05: No operator input processing (no key/push button checks)
- FAULT still takes priority over PBV (per CONTEXT.md)
- Direction memory cleared on exit to STOPPED (safety - no accidental resume)
  </action>
  <verify>PBV_RETRACT: FAULT->FAULT, endstop->IDLE_OPEN, timer->STOPPED, NO key/push button handling</verify>
  <done>PBV_RETRACT state complete with FAULT check, endstop detection, timer timeout, operator input ignored (SAF-05)</done>
</task>

<task type="auto">
  <name>Task 3: Implement VS_PAUSE state</name>
  <files>PLC/Sources/04_FB_HekBesturing.scl</files>
  <action>
Replace the placeholder for STATE_VS_PAUSE in the CASE statement:

```scl
"DB_States".STATE_VS_PAUSE:
    // Paused due to vehicle sensor (beam blocked)
    // SAF-08: Auto-resumes in same direction when beam clears
    // SAF-09: Ignores operator input during pause (auto-resume has priority)
    // Motor outputs OFF (handled in output section - not in MOVING states)

    // Safety checks FIRST (priority: FAULT > PBV > VS)
    IF #i_Fault THEN
        #m_Toestand := "DB_States".STATE_FAULT;
    ELSIF #i_PBV_Trigger THEN
        // PBV > VS: PBV can interrupt VS_PAUSE (statemachine.mmd line 49)
        #m_Toestand := "DB_States".STATE_PBV_RETRACT;
    ELSIF NOT #i_VS_Trigger THEN
        // Beam cleared - auto-resume in saved direction
        // NOTE: Phase 4 will add CFG_VS_HervattingMs delay before resume
        // For Phase 3, resume immediately when beam clears
        IF #m_VorigeRichtingVoorVS = "DB_States".DIR_OPEN THEN
            #m_Toestand := "DB_States".STATE_MOVING_OPEN;
        ELSIF #m_VorigeRichtingVoorVS = "DB_States".DIR_DICHT THEN
            #m_Toestand := "DB_States".STATE_MOVING_DICHT;
        ELSE
            // Safety fallback: no saved direction -> go to STOPPED
            #m_Toestand := "DB_States".STATE_STOPPED;
        END_IF;
    END_IF;
    // NOTE: Push button and key switch edges are IGNORED in this state (SAF-09)
    // Auto-resume has priority over operator input
```

Key behaviors per requirements:
- SAF-08: Auto-resume uses m_VorigeRichtingVoorVS (saved when entering VS_PAUSE)
- SAF-09: No operator input processing (no key/push button checks)
- PBV can interrupt VS_PAUSE (priority: FAULT > PBV > VS)
- Phase 4 will add the resume delay timer (CFG_VS_HervattingMs)
  </action>
  <verify>VS_PAUSE: FAULT->FAULT, PBV->PBV_RETRACT, beam clear->MOVING_* based on saved direction, NO key/push button handling</verify>
  <done>VS_PAUSE state complete with FAULT/PBV checks, auto-resume on beam clear using saved direction, operator input ignored (SAF-09)</done>
</task>

</tasks>

<verification>
After all tasks complete, verify the complete state machine through code review:

1. **PBV retract behavior:**
   - MOVING_DICHT + PBV -> PBV_RETRACT -> (motor toward OPEN)
   - MOVING_OPEN + PBV -> PBV_RETRACT -> (motor toward OPEN)
   - PBV_RETRACT + endstop OPEN reached -> IDLE_OPEN
   - PBV_RETRACT + timer elapsed -> STOPPED (m_LaatsteRichting=DIR_NONE)
   - PBV_RETRACT ignores key switch and push button

2. **VS pause behavior:**
   - MOVING_OPEN + VS -> VS_PAUSE (m_VorigeRichtingVoorVS=DIR_OPEN)
   - MOVING_DICHT + VS -> VS_PAUSE (m_VorigeRichtingVoorVS=DIR_DICHT)
   - VS_PAUSE + beam clear -> MOVING_* matching saved direction
   - VS_PAUSE + PBV -> PBV_RETRACT (PBV > VS priority)
   - VS_PAUSE ignores key switch and push button

3. **Output verification (full state machine):**
   - HOMING: q_MS_Dicht=TRUE, q_MS_Open=FALSE
   - MOVING_OPEN: q_MS_Open=TRUE, q_MS_Dicht=FALSE
   - MOVING_DICHT: q_MS_Dicht=TRUE, q_MS_Open=FALSE
   - PBV_RETRACT: q_MS_Open=TRUE, q_MS_Dicht=FALSE
   - IDLE_*, STOPPED, VS_PAUSE, FAULT: q_MS_Open=FALSE, q_MS_Dicht=FALSE
   - q_AlarmKerk: FALSE only in IDLE_DICHT, TRUE in all other states

4. **All 9 states implemented:**
   - STATE_HOMING (0), STATE_IDLE_OPEN (1), STATE_IDLE_DICHT (2)
   - STATE_MOVING_OPEN (3), STATE_MOVING_DICHT (4), STATE_STOPPED (5)
   - STATE_VS_PAUSE (6), STATE_PBV_RETRACT (7), STATE_FAULT (8)
</verification>

<success_criteria>
- All 9 states fully implemented (no more placeholders)
- PBV_RETRACT always moves toward OPEN (q_MS_Open=TRUE)
- PBV_RETRACT timer variable added and called
- PBV_RETRACT ignores operator input (SAF-05)
- VS_PAUSE saves and restores direction (m_VorigeRichtingVoorVS)
- VS_PAUSE ignores operator input (SAF-09)
- VS_PAUSE allows PBV interrupt (PBV > VS priority)
- Motor outputs mutually exclusive (verified in output section)
- Alarm output correct (FALSE only in IDLE_DICHT)
- Code compiles without syntax errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-state-machine/03-03-SUMMARY.md`
</output>

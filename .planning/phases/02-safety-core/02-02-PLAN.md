---
phase: 02-safety-core
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - PLC/Sources/03_FC_Veiligheid.scl
autonomous: true

must_haves:
  truths:
    - "FAULT has highest priority and masks PBV and VS"
    - "PBV has second priority and masks VS"
    - "VS trigger only active when FAULT and PBV are inactive"
    - "Combined SafetyStop output is TRUE when any safety condition active"
    - "Individual debug flags show which safety condition is active"
  artifacts:
    - path: "PLC/Sources/03_FC_Veiligheid.scl"
      provides: "Priority logic and combined safety outputs"
      contains: "q_SafetyStop"
  key_links:
    - from: "PLC/Sources/03_FC_Veiligheid.scl"
      to: "FB_HekBesturing"
      via: "q_SafetyStop output consumed by state machine"
      pattern: "q_SafetyStop"
---

<objective>
Implement safety priority logic (FAULT > PBV > VS) and add combined SafetyStop output with debug flags.

Purpose: Safety signals must be evaluated in priority order to prevent conflicts. The state machine needs a single SafetyStop signal plus individual flags for debugging.

Output: FB_Veiligheid with priority-enforced outputs ready for state machine consumption in Phase 3.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-safety-core/02-RESEARCH.md
@.planning/phases/02-safety-core/02-CONTEXT.md
@.planning/phases/02-safety-core/02-01-SUMMARY.md

# Code from Plan 01
@PLC/Sources/03_FC_Veiligheid.scl
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add combined SafetyStop output and debug flags</name>
  <files>PLC/Sources/03_FC_Veiligheid.scl</files>
  <action>
Extend VAR_OUTPUT section with additional outputs per CONTEXT.md decision:

```scl
VAR_OUTPUT
   q_PBV_Trigger : Bool;      // PBV geactiveerd (gedebounced, prioriteit toegepast)
   q_VS_Trigger : Bool;       // VS geactiveerd (gedebounced, prioriteit toegepast)
   q_Fault : Bool;            // Sensordefect gedetecteerd (hoogste prioriteit)

   // Combined safety output for state machine
   q_SafetyStop : Bool;       // TRUE = any safety condition active, motor must stop

   // Debug flags (individual active states, before priority masking)
   q_Debug_PBV_Active : Bool; // Raw debounced PBV state (before priority)
   q_Debug_VS_Active : Bool;  // Raw debounced VS state (before priority)
   q_Debug_Fault_Active : Bool; // Raw debounced FAULT state
END_VAR
```

These outputs serve different purposes:
- q_Fault/q_PBV_Trigger/q_VS_Trigger: Priority-masked outputs for state machine
- q_SafetyStop: Combined "motor must stop" signal
- q_Debug_*: Raw debounced values for troubleshooting (no priority masking)
  </action>
  <verify>FB_Veiligheid has q_SafetyStop and three q_Debug_* outputs in VAR_OUTPUT</verify>
  <done>Output interface extended with SafetyStop and debug flags</done>
</task>

<task type="auto">
  <name>Task 2: Implement priority logic per SAF-01</name>
  <files>PLC/Sources/03_FC_Veiligheid.scl</files>
  <action>
Replace the placeholder output assignments in BEGIN section with priority logic:

```scl
// =========================================================================
// STAP 1: DEBOUNCE (uitgevoerd door TON timers)
// =========================================================================
// FAULT: beide eindstanden tegelijk actief (NC: 0 = bereikt)
#m_RawFault := (NOT #i_BNS_Open) AND (NOT #i_BNS_Dicht);
#m_TON_Fault(IN := #m_RawFault, PT := "DB_Config".Timers.CFG_EndstopDebounceMs);

// PBV: NC sensor, 1 = trigger (bumper contact of draadbreuk)
#m_TON_PBV(IN := #i_PBV_BeweegbaarHek, PT := "DB_Config".Timers.CFG_EndstopDebounceMs);

// VS: 0 = onderbroken (voertuig in lichtsluis)
#m_RawVS_Blocked := NOT #i_VS_Voertuig;
#m_TON_VS(IN := #m_RawVS_Blocked, PT := "DB_Config".Safety.CFG_VS_DebounceMs);

// =========================================================================
// STAP 2: DEBUG FLAGS (raw debounced, geen prioriteit)
// =========================================================================
#q_Debug_Fault_Active := #m_TON_Fault.Q;
#q_Debug_PBV_Active := #m_TON_PBV.Q;
#q_Debug_VS_Active := #m_TON_VS.Q;

// =========================================================================
// STAP 3: PRIORITEITSLOGICA (SAF-01: FAULT > PBV > VS)
// =========================================================================
// Evalueer in prioriteitsvolgorde met masking

// FAULT: hoogste prioriteit, maskeert alles
#q_Fault := #m_TON_Fault.Q;

// PBV: tweede prioriteit, alleen actief als geen FAULT
#q_PBV_Trigger := #m_TON_PBV.Q AND NOT #q_Fault;

// VS: laagste prioriteit, alleen actief als geen FAULT en geen PBV
#q_VS_Trigger := #m_TON_VS.Q AND NOT #q_Fault AND NOT #q_PBV_Trigger;

// =========================================================================
// STAP 4: GECOMBINEERDE SAFETY STOP
// =========================================================================
// TRUE als ENIGE veiligheidsconditie actief is (na debounce)
#q_SafetyStop := #q_Fault OR #q_PBV_Trigger OR #q_VS_Trigger;
```

Priority logic explanation:
1. FAULT evaluated first - if both endstops active, system is in fault
2. PBV only triggers if no FAULT (prevents double-triggering on fault condition)
3. VS only triggers if no FAULT and no PBV (lowest priority)
4. SafetyStop is OR of all (for simple "stop motor" decision)

The debug flags bypass priority masking to show actual sensor states for troubleshooting.
  </action>
  <verify>Search for `AND NOT #q_Fault` to confirm PBV masking. Search for `AND NOT #q_PBV_Trigger` to confirm VS masking.</verify>
  <done>Priority order FAULT > PBV > VS enforced with masking. SAF-01 satisfied.</done>
</task>

<task type="auto">
  <name>Task 3: Update Main_OB1 to receive new outputs</name>
  <files>PLC/Sources/07_Main_OB1.scl</files>
  <action>
Add intermediate variables and update FB_Veiligheid call to capture new outputs:

1. Add to VAR_TEMP section:
   ```scl
   // Additional safety outputs
   t_SafetyStop : Bool;
   t_Debug_PBV_Active : Bool;
   t_Debug_VS_Active : Bool;
   t_Debug_Fault_Active : Bool;
   ```

2. Update the FB_Veiligheid call to include new outputs:
   ```scl
   "FB_Veiligheid"."DB_HekData".m_Veiligheid(
       i_PBV_BeweegbaarHek := %I1.2,
       i_VS_Voertuig := %I1.3,
       i_BNS_Open := %I0.7,
       i_BNS_Dicht := %I1.0,
       q_PBV_Trigger => #t_PBV_Trigger,
       q_VS_Trigger => #t_VS_Trigger,
       q_Fault => #t_Fault,
       q_SafetyStop => #t_SafetyStop,
       q_Debug_PBV_Active => #t_Debug_PBV_Active,
       q_Debug_VS_Active => #t_Debug_VS_Active,
       q_Debug_Fault_Active => #t_Debug_Fault_Active
   );
   ```

3. Add t_SafetyStop to FB_HekBesturing call (new input parameter needed):
   - Note: FB_HekBesturing already receives i_PBV_Trigger, i_VS_Trigger, i_Fault
   - The t_SafetyStop will be used in Phase 3 when state machine is implemented
   - For now, just capture the value; Phase 3 will add the input parameter to FB_HekBesturing
  </action>
  <verify>Main_OB1 captures q_SafetyStop output. VAR_TEMP contains t_SafetyStop.</verify>
  <done>OB1 captures all FB_Veiligheid outputs including SafetyStop and debug flags</done>
</task>

</tasks>

<verification>
After completion:
1. FB_Veiligheid has 7 outputs (3 priority-masked + SafetyStop + 3 debug flags)
2. Priority masking: `#q_PBV_Trigger := ... AND NOT #q_Fault`
3. Priority masking: `#q_VS_Trigger := ... AND NOT #q_Fault AND NOT #q_PBV_Trigger`
4. SafetyStop is OR of all three priority-masked triggers
5. Debug flags are raw debounced values without masking
6. Main_OB1 captures all outputs in VAR_TEMP
</verification>

<success_criteria>
- Priority order enforced: FAULT masks all, PBV masks VS
- q_SafetyStop TRUE when any safety condition active
- Debug flags show raw debounced states (for troubleshooting)
- All outputs captured in Main_OB1
- Satisfies: SAF-01 (priority order), SAF-02 (PBV immediate stop via SafetyStop), SAF-07 (VS immediate pause via SafetyStop)
- Prepares for: SAF-03/04/05 (PBV retract behavior - Phase 3), SAF-08/09 (VS auto-resume - Phase 3)
</success_criteria>

<output>
After completion, create `.planning/phases/02-safety-core/02-02-SUMMARY.md`
</output>

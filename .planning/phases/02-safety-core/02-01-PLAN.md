---
phase: 02-safety-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - PLC/Sources/03_FC_Veiligheid.scl
  - PLC/Sources/05_DB_HekData.scl
  - PLC/Sources/07_Main_OB1.scl
autonomous: true

must_haves:
  truths:
    - "FB_Veiligheid has internal TON timer instances for debouncing"
    - "PBV sensor debounced with 50ms delay (CFG_EndstopDebounceMs)"
    - "VS sensor debounced with 100ms delay (CFG_VS_DebounceMs)"
    - "FAULT condition debounced with 50ms delay"
    - "OB1 calls FB_Veiligheid via instance DB"
  artifacts:
    - path: "PLC/Sources/03_FC_Veiligheid.scl"
      provides: "FB_Veiligheid function block with timer instances"
      contains: "FUNCTION_BLOCK"
    - path: "PLC/Sources/05_DB_HekData.scl"
      provides: "Instance DB includes FB_Veiligheid instance"
      contains: "m_Veiligheid"
    - path: "PLC/Sources/07_Main_OB1.scl"
      provides: "Updated call to FB_Veiligheid"
      contains: "FB_Veiligheid"
  key_links:
    - from: "PLC/Sources/03_FC_Veiligheid.scl"
      to: "DB_Config"
      via: "Timer PT parameters"
      pattern: "DB_Config.*CFG_.*DebounceMs"
    - from: "PLC/Sources/07_Main_OB1.scl"
      to: "PLC/Sources/03_FC_Veiligheid.scl"
      via: "FB instance call"
      pattern: "FB_Veiligheid.*DB_HekData"
---

<objective>
Convert FC_Veiligheid to FB_Veiligheid and implement sensor debouncing with IEC TON timers.

Purpose: FCs cannot hold timer state between cycles. Converting to FB enables internal timer instances for debouncing PBV, VS, and FAULT signals per the research findings.

Output: FB_Veiligheid with debounced sensor outputs, updated OB1 call structure.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-safety-core/02-RESEARCH.md
@.planning/phases/02-safety-core/02-CONTEXT.md
@.planning/phases/01-foundation/01-02-SUMMARY.md

# Existing code to modify
@PLC/Sources/03_FC_Veiligheid.scl
@PLC/Sources/05_DB_HekData.scl
@PLC/Sources/07_Main_OB1.scl
@PLC/Sources/02_DB_Config.scl
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert FC_Veiligheid to FB_Veiligheid with timer instances</name>
  <files>PLC/Sources/03_FC_Veiligheid.scl</files>
  <action>
Convert the existing Function (FC) to a Function Block (FB):

1. Change declaration from `FUNCTION "FC_Veiligheid" : Void` to `FUNCTION_BLOCK "FB_Veiligheid"`
2. Keep existing VAR_INPUT and VAR_OUTPUT sections unchanged
3. Replace VAR_TEMP section with VAR (static) section containing:
   - `m_TON_PBV : TON;` - Timer for PBV debounce
   - `m_TON_VS : TON;` - Timer for VS debounce
   - `m_TON_Fault : TON;` - Timer for FAULT debounce
   - `m_RawFault : Bool;` - Intermediate: both endstops active
   - `m_RawVS_Blocked : Bool;` - Intermediate: VS beam blocked

4. Implement debounce logic in BEGIN section:
   ```scl
   // FAULT detection: beide eindstanden tegelijk actief (NC: 0 = bereikt)
   #m_RawFault := (NOT #i_BNS_Open) AND (NOT #i_BNS_Dicht);
   #m_TON_Fault(IN := #m_RawFault, PT := "DB_Config".Timers.CFG_EndstopDebounceMs);

   // PBV: NC sensor, 1 = trigger
   #m_TON_PBV(IN := #i_PBV_BeweegbaarHek, PT := "DB_Config".Timers.CFG_EndstopDebounceMs);

   // VS: 0 = onderbroken (trigger)
   #m_RawVS_Blocked := NOT #i_VS_Voertuig;
   #m_TON_VS(IN := #m_RawVS_Blocked, PT := "DB_Config".Safety.CFG_VS_DebounceMs);
   ```

5. Leave output assignments as placeholders (priority logic in Plan 02):
   ```scl
   // Debounced outputs - priority logic in Plan 02
   #q_Fault := #m_TON_Fault.Q;
   #q_PBV_Trigger := #m_TON_PBV.Q;
   #q_VS_Trigger := #m_TON_VS.Q;
   ```

6. Update header comment to reflect FB conversion and debounce implementation
7. Rename file to keep consistency (file remains 03_FC_Veiligheid.scl for import order, but content is FB)

NC Sensor logic reminder (from RESEARCH.md):
- i_PBV_BeweegbaarHek: NC, 1 = trigger (bumper hit or wire break)
- i_VS_Voertuig: 0 = blocked, 1 = intact
- i_BNS_Open/Dicht: NC, 0 = reached, 1 = not reached
  </action>
  <verify>File contains `FUNCTION_BLOCK "FB_Veiligheid"` and three TON timer declarations in VAR section</verify>
  <done>FB_Veiligheid has TON timers for PBV (50ms), VS (100ms), and FAULT (50ms) using DB_Config parameters</done>
</task>

<task type="auto">
  <name>Task 2: Update DB_HekData and Main_OB1 call structure</name>
  <files>PLC/Sources/05_DB_HekData.scl, PLC/Sources/07_Main_OB1.scl</files>
  <action>
1. Modify DB_HekData to add FB_Veiligheid instance:
   - Add inside the STRUCT (before FB_HekBesturing reference):
     ```scl
     m_Veiligheid : "FB_Veiligheid";  // Instantie veiligheidsverwerking
     ```
   - Keep existing FB_HekBesturing reference

2. Update Main_OB1 call syntax:
   - Change `"FC_Veiligheid"(...)` to `"FB_Veiligheid"."DB_HekData".m_Veiligheid(...)`
   - Keep all input/output parameter mappings identical
   - The call should look like:
     ```scl
     "FB_Veiligheid"."DB_HekData".m_Veiligheid(
         i_PBV_BeweegbaarHek := %I1.2,
         i_VS_Voertuig := %I1.3,
         i_BNS_Open := %I0.7,
         i_BNS_Dicht := %I1.0,
         q_PBV_Trigger => #t_PBV_Trigger,
         q_VS_Trigger => #t_VS_Trigger,
         q_Fault => #t_Fault
     );
     ```

3. Update comment block in Main_OB1 to reflect FB_Veiligheid change

Note: The call syntax `"FB_Veiligheid"."DB_HekData".m_Veiligheid(...)` accesses the FB instance stored inside DB_HekData.
  </action>
  <verify>DB_HekData contains `m_Veiligheid` instance. Main_OB1 compiles with new FB call syntax.</verify>
  <done>OB1 calls FB_Veiligheid via instance in DB_HekData, timer state persists between cycles</done>
</task>

</tasks>

<verification>
After completion:
1. Search 03_FC_Veiligheid.scl for `FUNCTION_BLOCK` declaration
2. Search 03_FC_Veiligheid.scl for `m_TON_PBV`, `m_TON_VS`, `m_TON_Fault` in VAR section
3. Search 05_DB_HekData.scl for `m_Veiligheid : "FB_Veiligheid"`
4. Search 07_Main_OB1.scl for `FB_Veiligheid.*m_Veiligheid` call pattern
5. Verify debounce times reference DB_Config parameters
</verification>

<success_criteria>
- FB_Veiligheid declared with three TON timer instances in static VAR
- Debounce logic uses DB_Config.Timers.CFG_EndstopDebounceMs (50ms) for PBV and FAULT
- Debounce logic uses DB_Config.Safety.CFG_VS_DebounceMs (100ms) for VS
- DB_HekData contains m_Veiligheid instance
- Main_OB1 calls FB via instance syntax
- Satisfies: SAF-06 (PBV debounce), SAF-10 (VS debounce), SEN-01/SEN-02 (endstop debounce)
</success_criteria>

<output>
After completion, create `.planning/phases/02-safety-core/02-01-SUMMARY.md`
</output>

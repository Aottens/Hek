---
phase: 04-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - PLC/Sources/04_FB_HekBesturing.scl
autonomous: true

must_haves:
  truths:
    - "Low speed timer accumulates during movement, pauses on stop"
    - "Low speed timer resets on direction change"
    - "Timers called before CASE statement, Q captured once per scan"
    - "Low speed output active for first 5s of movement"
    - "Low speed active during HOMING and PBV_RETRACT"
  artifacts:
    - path: "PLC/Sources/04_FB_HekBesturing.scl"
      provides: "Timer infrastructure and low speed logic"
      contains: "m_TONR_LaagToeren"
  key_links:
    - from: "m_TONR_LaagToeren"
      to: "q_MS_LaagToeren"
      via: "Low speed output determination"
      pattern: "q_MS_LaagToeren.*m_TONR_LaagToeren"
---

<objective>
Add timer infrastructure and low speed logic to FB_HekBesturing.

Purpose: Implement TMR-01, TMR-08, TMR-09 - pausable low speed timer with direction change reset, timers called outside CASE statement.

Output: FB_HekBesturing with working low speed output based on TONR timers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-integration/04-RESEARCH.md
@PLC/Sources/04_FB_HekBesturing.scl
@PLC/Sources/02_DB_Config.scl
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add timer variables and direction change detection</name>
  <files>PLC/Sources/04_FB_HekBesturing.scl</files>
  <action>
Add to VAR section of FB_HekBesturing:

1. TONR timer instances:
   - m_TONR_LaagToeren : TONR;        // Normal start low speed (5s)
   - m_TONR_VS_LaagToeren : TONR;     // Post-VS resume low speed (2s)

2. TON timer instances:
   - m_TON_VS_Hervatting : TON;       // VS resume delay (2s)
   - m_TON_PBV_Pauze : TON;           // PBV pause before retract (500ms)

3. Direction change tracking:
   - m_VorigeRichting : Int;          // Previous direction for change detection

4. Timer output captures:
   - m_LowSpeedDone : Bool;           // Start low speed timer complete
   - m_VS_LowSpeedDone : Bool;        // VS low speed timer complete
   - m_VS_ResumeDelayDone : Bool;     // VS resume delay complete
   - m_PBV_PauseDone : Bool;          // PBV pause complete

5. State tracking:
   - m_VS_ResumeActive : Bool;        // Flag: currently resuming from VS (for VS low speed)
   - m_PBV_Retracting : Bool;         // Flag: PBV retract in progress (after pause)

Note: TONR is the S7-1200 retentive on-delay timer that pauses when IN=FALSE and resets via R input. This matches TMR-08 behavior exactly.
  </action>
  <verify>
Grep for "m_TONR_LaagToeren" and "m_VorigeRichting" in FB_HekBesturing.scl - both should exist in VAR section.
  </verify>
  <done>
Timer instances and direction tracking variables declared in FB_HekBesturing VAR section.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add timer calls before CASE statement</name>
  <files>PLC/Sources/04_FB_HekBesturing.scl</files>
  <action>
After edge detection calls and before the main state machine CASE statement, add timer logic (TMR-09: timers called outside CASE, Q captured once per scan):

1. Add VAR_TEMP for computed conditions:
   ```
   VAR_TEMP
       t_DirectionChanged : Bool;
       t_MotorMoving : Bool;
       t_ReachedEndstop : Bool;
   END_VAR
   ```

2. Direction change detection (for timer reset):
   ```
   // Detect direction change - resets low speed timer (TMR-08)
   #t_DirectionChanged := (#m_LaatsteRichting <> #m_VorigeRichting) AND
                          (#m_LaatsteRichting <> "DB_States".DIR_NONE) AND
                          (#m_VorigeRichting <> "DB_States".DIR_NONE);
   #m_VorigeRichting := #m_LaatsteRichting;
   ```

3. Compute motor moving condition:
   ```
   // Motor moving in normal movement states
   #t_MotorMoving := (#m_Toestand = "DB_States".STATE_MOVING_OPEN) OR
                     (#m_Toestand = "DB_States".STATE_MOVING_DICHT);
   ```

4. Compute endstop reached condition:
   ```
   // Reached endstop (timer reset condition)
   #t_ReachedEndstop := (NOT #i_BNS_Open) OR (NOT #i_BNS_Dicht);
   ```

5. Normal start low speed timer (TMR-01):
   ```
   #m_TONR_LaagToeren(
       IN := #t_MotorMoving,
       PT := "DB_Config".Timers.CFG_LaagToerenMs,
       R := #t_DirectionChanged OR #t_ReachedEndstop,
       Q => #m_LowSpeedDone
   );
   ```

6. Post-VS resume low speed timer (TMR-05):
   ```
   #m_TONR_VS_LaagToeren(
       IN := #t_MotorMoving AND #m_VS_ResumeActive,
       PT := "DB_Config".Timers.CFG_VS_LaagToerenMs,
       R := #t_DirectionChanged OR #t_ReachedEndstop OR (NOT #m_VS_ResumeActive),
       Q => #m_VS_LowSpeedDone
   );
   ```

7. VS resume delay timer (TMR-04):
   ```
   #m_TON_VS_Hervatting(
       IN := (#m_Toestand = "DB_States".STATE_VS_PAUSE) AND (NOT #i_VS_Trigger),
       PT := "DB_Config".Timers.CFG_VS_HervattingMs,
       Q => #m_VS_ResumeDelayDone
   );
   ```

8. PBV pause timer (TMR-02):
   ```
   #m_TON_PBV_Pauze(
       IN := (#m_Toestand = "DB_States".STATE_PBV_RETRACT) AND (NOT #m_PBV_Retracting),
       PT := "DB_Config".Timers.CFG_PBV_PauzeMs,
       Q => #m_PBV_PauseDone
   );
   ```

Place all timer calls AFTER edge detection but BEFORE the "Save previous state" comment and CASE statement.
  </action>
  <verify>
Grep for "m_TONR_LaagToeren.*IN :=" in FB_HekBesturing.scl - should show timer call before CASE statement.
  </verify>
  <done>
All timers called before CASE statement per TMR-09, with correct IN/PT/R/Q parameters.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement low speed output determination</name>
  <files>PLC/Sources/04_FB_HekBesturing.scl</files>
  <action>
Replace the placeholder low speed logic (currently `#q_MS_LaagToeren := FALSE;`) with proper determination after the motor output CASE statement:

```
// =========================================================================
// Low speed output determination (TMR-01, TMR-05)
// =========================================================================
// Low speed active when:
// 1. In HOMING (always low speed per FDS 2.2)
// 2. In PBV_RETRACT (always low speed per FDS 5.2)
// 3. In MOVING_* and start timer not complete (first CFG_LaagToerenMs)
// 4. In MOVING_* after VS resume and VS timer not complete (CFG_VS_LaagToerenMs)

VAR_TEMP
    t_InMovement : Bool;
    t_NormalLowSpeed : Bool;
    t_VS_LowSpeed : Bool;
END_VAR

#t_InMovement := (#m_Toestand = "DB_States".STATE_MOVING_OPEN) OR
                 (#m_Toestand = "DB_States".STATE_MOVING_DICHT);

// Normal start low speed: during movement, timer not complete
#t_NormalLowSpeed := #t_InMovement AND NOT #m_LowSpeedDone;

// VS resume low speed: after VS, timer not complete
#t_VS_LowSpeed := #t_InMovement AND #m_VS_ResumeActive AND NOT #m_VS_LowSpeedDone;

// Final low speed determination
#q_MS_LaagToeren := (#m_Toestand = "DB_States".STATE_HOMING) OR
                    (#m_Toestand = "DB_States".STATE_PBV_RETRACT) OR
                    #t_NormalLowSpeed OR
                    #t_VS_LowSpeed;
```

Note: The VAR_TEMP block should be at the beginning of the function body with the other VAR_TEMP declarations, but the assignment logic goes after the motor output CASE statement.

Also add logic to clear m_VS_ResumeActive when low speed timer completes or when reaching endstop:
```
// Clear VS resume flag when VS low speed complete or at endstop
IF #m_VS_LowSpeedDone OR #t_ReachedEndstop THEN
    #m_VS_ResumeActive := FALSE;
END_IF;
```
  </action>
  <verify>
Grep for "q_MS_LaagToeren.*STATE_HOMING" in FB_HekBesturing.scl - should show low speed active during HOMING.
  </verify>
  <done>
Low speed output correctly determined based on state and timer status. HOMING and PBV_RETRACT always low speed. Normal movement low speed for first 5s. VS resume low speed for 2s after resume.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Timer variables in VAR section:
   - grep "m_TONR_LaagToeren" -> exists
   - grep "m_TONR_VS_LaagToeren" -> exists
   - grep "m_TON_VS_Hervatting" -> exists
   - grep "m_TON_PBV_Pauze" -> exists

2. Timer calls before CASE:
   - Verify timers called after edge detection, before CASE statement
   - Each timer has IN, PT, R (for TONR) or IN, PT (for TON), and Q output

3. Low speed logic:
   - grep "q_MS_LaagToeren.*STATE_HOMING" -> shows HOMING always low speed
   - grep "q_MS_LaagToeren.*STATE_PBV_RETRACT" -> shows PBV_RETRACT always low speed
   - grep "m_LowSpeedDone" -> shows normal movement uses timer
</verification>

<success_criteria>
- [ ] TONR timers (m_TONR_LaagToeren, m_TONR_VS_LaagToeren) declared and called
- [ ] TON timers (m_TON_VS_Hervatting, m_TON_PBV_Pauze) declared and called
- [ ] Direction change detection for timer reset
- [ ] All timers called before CASE statement (TMR-09)
- [ ] Low speed output: HOMING always, PBV_RETRACT always, first 5s of movement, 2s after VS resume
- [ ] m_VS_ResumeActive flag set in VS resume transition, cleared after timer
</success_criteria>

<output>
After completion, create `.planning/phases/04-integration/04-01-SUMMARY.md`
</output>

---
phase: 05-fat-document
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - FAT-Automatisch-Hek.md
autonomous: true

must_haves:
  truths:
    - "Tester can verify push button at IDLE has no effect"
    - "Tester can verify PBV always retracts toward OPEN regardless of movement direction"
    - "Tester can verify VS detection causes pause and auto-resume"
    - "Tester can verify FAULT detection and auto-recovery"
    - "Tester can verify priority order: FAULT > PBV > VS"
    - "Tester can perform wire-break test for each NC sensor"
  artifacts:
    - path: "FAT-Automatisch-Hek.md"
      provides: "Edge case test section"
      contains: "## 7. Edge Case Tests"
    - path: "FAT-Automatisch-Hek.md"
      provides: "Safety test section"
      contains: "## 8. Safety Tests"
  key_links:
    - from: "FAT-Automatisch-Hek.md (EDGE tests)"
      to: "FB_HekBesturing edge cases"
      via: "Documented edge behaviors match code"
      pattern: "EDGE-0[1-7]"
    - from: "FAT-Automatisch-Hek.md (SAF tests)"
      to: "FC_Veiligheid"
      via: "Safety behavior matches code"
      pattern: "SAF-0[1-9]|SAF-10"
---

<objective>
Add Edge Case and Safety test sections to complete FAT document.

Purpose: Enable testers to verify edge cases and all safety-critical behaviors.
Output: Complete FAT-Automatisch-Hek.md with all 7 sections.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/05-fat-document/05-RESEARCH.md
@.planning/phases/05-fat-document/05-02-SUMMARY.md
@FDS-Automatisch-Hek-v0.2.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Edge Case test section</name>
  <files>FAT-Automatisch-Hek.md</files>
  <action>
Append Section 7: Edge Case Tests to FAT-Automatisch-Hek.md

Create table with columns: Test ID | Voorwaarde | Actie | Verwacht Resultaat | Reden | Pass/Fail | Opmerkingen

**Edge Case Tests (EDGE-01 through EDGE-07):**

EDGE-01 (Push button at IDLE - no action, no direction memory):
- EDGE-01a: At IDLE_DICHT, press push button -> No action, gate stays IDLE_DICHT
- EDGE-01b: At IDLE_OPEN, press push button -> No action, gate stays IDLE_OPEN
- EDGE-01c: Reason: No direction memory at endstops, nothing to resume

EDGE-02 (PBV at IDLE_OPEN - stay, already safest):
- EDGE-02a: At IDLE_OPEN, trigger PBV (press bumper) -> No action, stay IDLE_OPEN
- EDGE-02b: Reason: Already at safest position (fully open), no retraction needed

EDGE-03 (Direction memory cleared at endstops):
- EDGE-03a: Move OPEN until IDLE_OPEN reached
- EDGE-03b: Press push button -> No resume (direction cleared)
- EDGE-03c: Only key switch can start new movement

EDGE-04 (Push button during HOMING -> STOPPED):
- EDGE-04a: Power on in unknown position, HOMING starts
- EDGE-04b: Press push button during HOMING -> Gate stops, STOPPED state
- EDGE-04c: Reason: User safety override allowed during homing

EDGE-05 (Bediening ignored during PBV_RETRACT):
- EDGE-05a: Trigger PBV during movement, enter PBV_RETRACT
- EDGE-05b: Turn key DICHT during retract -> Ignored, retract continues
- EDGE-05c: Press push button during retract -> Ignored, retract continues
- EDGE-05d: Reason: Safety retraction must complete

EDGE-06 (Bediening ignored during VS_PAUSE):
- EDGE-06a: Block beam during movement, enter VS_PAUSE
- EDGE-06b: Turn key (either direction) -> Ignored, wait for beam clear
- EDGE-06c: Press push button -> Ignored, wait for beam clear
- EDGE-06d: Reason: Auto-resume has priority

EDGE-07 (PBV during VS_PAUSE - PBV wins):
- EDGE-07a: Block beam during movement, enter VS_PAUSE
- EDGE-07b: While in VS_PAUSE, trigger PBV (press bumper)
- EDGE-07c: Gate transitions to PBV_RETRACT (not stay in VS_PAUSE)
- EDGE-07d: Reason: Priority order FAULT > PBV > VS

Include "Reden" (Reason) column to explain WHY each edge case behaves this way.
  </action>
  <verify>
grep "EDGE-01" FAT-Automatisch-Hek.md returns result. grep "EDGE-07" FAT-Automatisch-Hek.md confirms PBV>VS priority test present.
  </verify>
  <done>
Section 7 contains all 7 EDGE requirements with preconditions, actions, expected results, and explanatory reasons.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Safety test section</name>
  <files>FAT-Automatisch-Hek.md</files>
  <action>
Append Section 8: Safety Tests to FAT-Automatisch-Hek.md

Create table with columns: Test ID | Veiligheid | Test Procedure | Verwacht Resultaat | Pass/Fail | Opmerkingen

**Safety Tests (SAF-01 through SAF-10):**

SAF-01 (PBV detection and 500ms pause + retract sequence):
- SAF-01a: Start movement DICHT
- SAF-01b: Trigger PBV (press rubber bumper)
- SAF-01c: Motor stops immediately
- SAF-01d: Wait 500ms (CFG_PBV_PauzeMs)
- SAF-01e: Motor starts OPEN direction at low speed
- SAF-01f: Movement continues until BNS_Open or 3s timer

SAF-02 (PBV always retracts toward OPEN):
- SAF-02a: Start movement OPEN, trigger PBV -> Motor continues OPEN (same direction)
- SAF-02b: Start movement DICHT, trigger PBV -> Motor reverses to OPEN
- SAF-02c: Reason: Opening the gate is always the safest action

SAF-03 (VS detection and auto-resume with delay + low speed):
- SAF-03a: Start movement, block beam -> Motor stops (VS_PAUSE)
- SAF-03b: Unblock beam
- SAF-03c: Wait 2s (CFG_VS_HervattingMs)
- SAF-03d: Motor resumes SAME direction at low speed
- SAF-03e: Low speed for 2s (CFG_VS_LaagToerenMs), then normal speed

SAF-04 (FAULT detection - both endstops active):
- SAF-04a: Simulate both i_BNS_Open=0 AND i_BNS_Dicht=0 simultaneously
- SAF-04b: Gate immediately enters FAULT state
- SAF-04c: All motor outputs = 0
- SAF-04d: All bediening ignored

SAF-05 (FAULT auto-recovery to correct state):
- SAF-05a: From FAULT, clear sensor error (only BNS_Dicht active) -> IDLE_DICHT
- SAF-05b: From FAULT, clear sensor error (only BNS_Open active) -> IDLE_OPEN
- SAF-05c: From FAULT, clear sensor error (no endstop active) -> STOPPED

SAF-06 (Priority: FAULT > PBV > VS):
- SAF-06a: During PBV_RETRACT, simulate FAULT -> Immediate FAULT, retract aborted
- SAF-06b: During VS_PAUSE, trigger PBV -> PBV_RETRACT (PBV > VS)
- SAF-06c: During VS_PAUSE, simulate FAULT -> FAULT (FAULT > VS)

SAF-07 (Debounce behavior):
- SAF-07a: Briefly toggle BNS_Open (< 50ms) -> No state change (debounced)
- SAF-07b: Hold BNS_Open for > 50ms -> State change occurs
- SAF-07c: Briefly toggle i_VS_Voertuig (< 100ms) -> No VS_PAUSE (debounced)
- SAF-07d: Hold beam blocked > 100ms -> VS_PAUSE activates
- SAF-07e: Debounce values: 50ms (endstop, PBV), 100ms (VS)

SAF-08 (Motor mutual exclusion):
- SAF-08a: During MOVING_OPEN, verify q_MS_Dicht = 0
- SAF-08b: During MOVING_DICHT, verify q_MS_Open = 0
- SAF-08c: Never both motor outputs active simultaneously
- SAF-08d: Check this in ALL states that have motor output

SAF-09 (Alarm fail-safe: 0 = active = hek dicht):
- SAF-09a: Gate at IDLE_DICHT -> q_AlarmKerk = 0 (alarm ON)
- SAF-09b: Gate at any other state -> q_AlarmKerk = 1 (alarm OFF)
- SAF-09c: Disconnect q_AlarmKerk wire -> Alarm activates (fail-safe)
- SAF-09d: Power off PLC -> Alarm activates (fail-safe)

SAF-10 (Wire-break test for each NC sensor):
Create sub-table for wire-break tests:
| Sensor | Test | Verwacht | Pass/Fail | Opmerkingen |
|--------|------|----------|-----------|-------------|
| i_DK_Bediening | Disconnect wire | PLC reads 1 (NC open) | [ ] | |
| i_BNS_Open | Disconnect wire | PLC reads 1 (NC open), sensor not reached | [ ] | |
| i_BNS_Dicht | Disconnect wire | PLC reads 1 (NC open), sensor not reached | [ ] | |
| i_PBV_BeweegbaarHek | Disconnect wire | PLC reads 1 (trigger = safe fail) | [ ] | |

Note: Wire-break for NC sensors results in safe state (trigger or open-circuit detection).
  </action>
  <verify>
grep "SAF-01" FAT-Automatisch-Hek.md returns result. grep "SAF-10" FAT-Automatisch-Hek.md confirms wire-break test present.
  </verify>
  <done>
Section 8 contains all 10 SAF requirements with detailed test procedures and expected results.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add document footer and traceability</name>
  <files>FAT-Automatisch-Hek.md</files>
  <action>
Append final sections to complete the FAT document:

**Section 9: Test Summary**
Create summary table:
| Sectie | Tests | Passed | Failed | N/A |
|--------|-------|--------|--------|-----|
| 2. Input Verification | 7 | | | |
| 3. Output Verification | 4 | | | |
| 4. State Machine | ~35 | | | |
| 5. Control Behavior | ~15 | | | |
| 6. Timer Behavior | ~20 | | | |
| 7. Edge Cases | 7 | | | |
| 8. Safety Tests | ~25 | | | |
| **Totaal** | **~115** | | | |

**Section 10: Traceability Matrix**
Create requirement traceability table:
| Requirement | Test ID(s) | Status |
|-------------|------------|--------|
| IO-01 | IO-INP-01 t/m IO-INP-07 | |
| IO-02 | IO-OUT-01 t/m IO-OUT-04 | |
| IO-03 | All I/O tests | |
| STATE-01 | SM-STATE-01 t/m SM-STATE-09 | |
| STATE-02 | SM-TRANS-01 t/m SM-TRANS-xx | |
| STATE-03 | All SM tests | |
| CTL-01 | CTL-01a t/m CTL-01c | |
| (continue for all requirements...) |

**Section 11: Sign-off**
| Rol | Naam | Handtekening | Datum |
|-----|------|--------------|-------|
| Tester | | | |
| Witness | | | |
| Project Lead | | | |

**Document Footer**
---
*FAT Document Version: 1.0*
*Based on: FDS-Automatisch-Hek v0.2, v1.0 SCL code*
*Generated: [Date]*

Ensure DOC-04 (printable/usable) by keeping tables clean and avoiding complex formatting.
Ensure DOC-05 (traceable) by including requirement IDs in test IDs and traceability matrix.
  </action>
  <verify>
grep "Traceability" FAT-Automatisch-Hek.md returns result. grep "Sign-off" FAT-Automatisch-Hek.md confirms sign-off section present.
  </verify>
  <done>
FAT document is complete with all 11 sections, test summary, traceability matrix, and sign-off page.
  </done>
</task>

</tasks>

<verification>
After completion:
1. Document has sections 1-11 complete
2. All 40 Phase 5 requirements covered (IO-01 through DOC-05)
3. Every test has Pass/Fail checkbox
4. Every test has Opmerkingen/Remarks column
5. Traceability matrix links requirements to test IDs
6. Sign-off section present for tester signatures
7. Document is printable (no complex Markdown features)
</verification>

<success_criteria>
Requirements covered:
- EDGE-01 through EDGE-07: All edge cases documented
- SAF-01 through SAF-10: All safety tests documented
- DOC-04: Document is printable/usable during hardware testing
- DOC-05: Test IDs are traceable to FDS sections or code comments

Phase 5 complete when:
- All 40 requirements (IO, STATE, CTL, TMR, EDGE, SAF, DOC) have corresponding tests
- FAT document is ready for use during hardware FAT
</success_criteria>

<output>
After completion, create `.planning/phases/05-fat-document/05-03-SUMMARY.md`
</output>

---
phase: 05-fat-document
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - FAT-Automatisch-Hek.md
autonomous: true

must_haves:
  truths:
    - "Tester can verify key switch OPEN starts movement to OPEN"
    - "Tester can verify key switch DICHT starts movement to DICHT"
    - "Tester can verify push button stops movement (falling edge)"
    - "Tester can verify push button resumes from STOPPED (last direction)"
    - "Tester can verify all 8 timer behaviors with trigger conditions and durations"
  artifacts:
    - path: "FAT-Automatisch-Hek.md"
      provides: "Control behavior test section"
      contains: "## 5. Control Behavior Tests"
    - path: "FAT-Automatisch-Hek.md"
      provides: "Timer behavior test section"
      contains: "## 6. Timer Behavior Tests"
  key_links:
    - from: "FAT-Automatisch-Hek.md (CTL tests)"
      to: "FDS section 4.1-4.3"
      via: "Control behavior matches FDS"
      pattern: "CTL-0[1-7]"
    - from: "FAT-Automatisch-Hek.md (TMR tests)"
      to: "DB_Config values"
      via: "Timer durations match configuration"
      pattern: "CFG_.*Ms|5s|500ms|3s|2s|90s"
---

<objective>
Add Control Behavior and Timer Behavior test sections to FAT document.

Purpose: Enable testers to verify key switch, push button, and timer behaviors.
Output: FAT-Automatisch-Hek.md extended with Sections 5 and 6.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/05-fat-document/05-RESEARCH.md
@.planning/phases/05-fat-document/05-01-SUMMARY.md
@FDS-Automatisch-Hek-v0.2.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Control Behavior test section</name>
  <files>FAT-Automatisch-Hek.md</files>
  <action>
Append Section 5: Control Behavior Tests to FAT-Automatisch-Hek.md

Create table with columns: Test ID | Voorwaarde | Actie | Verwacht Resultaat | Pass/Fail | Opmerkingen

**Section 5.1: Key Switch Tests (CTL-01, CTL-02, CTL-05, CTL-06, CTL-07)**

CTL-01 (Key OPEN command - momentary, rising edge):
- CTL-01a: From IDLE_DICHT, turn key briefly to OPEN -> Gate starts MOVING_OPEN
- CTL-01b: Release key immediately -> Movement continues autonomously
- CTL-01c: Key held vs momentary -> Same result (edge-triggered)

CTL-02 (Key DICHT command - momentary, rising edge):
- CTL-02a: From IDLE_OPEN, turn key briefly to DICHT -> Gate starts MOVING_DICHT
- CTL-02b: Release key immediately -> Movement continues autonomously

CTL-05 (Key overrides direction from STOPPED):
- CTL-05a: From STOPPED (last direction OPEN), turn key DICHT -> Gate moves DICHT
- CTL-05b: From STOPPED (last direction DICHT), turn key OPEN -> Gate moves OPEN

CTL-06 (Opposing key during movement -> STOPPED):
- CTL-06a: During MOVING_OPEN, turn key DICHT -> Gate stops (STOPPED state)
- CTL-06b: During MOVING_DICHT, turn key OPEN -> Gate stops (STOPPED state)

CTL-07 (Key release required after timeout):
- CTL-07a: After 90s movement timeout, key inputs ignored while held
- CTL-07b: Release both keys, then turn key -> Movement accepted

**Section 5.2: Push Button Tests (CTL-03, CTL-04)**

CTL-03 (Push button stop - falling edge, NC sensor):
- CTL-03a: During MOVING_OPEN, press button (0 signal) -> Motor stops
- CTL-03b: During MOVING_DICHT, press button -> Motor stops
- CTL-03c: Detection is falling edge (1->0 transition)

CTL-04 (Push button resume from STOPPED):
- CTL-04a: From STOPPED (last direction OPEN), press button -> Resumes MOVING_OPEN
- CTL-04b: From STOPPED (last direction DICHT), press button -> Resumes MOVING_DICHT
- CTL-04c: Press and release required (edge detection)

Note: Each test must specify "momentary" or "press and release" to emphasize edge detection behavior. Use falling edge symbol in description where appropriate.
  </action>
  <verify>
grep "CTL-01" FAT-Automatisch-Hek.md returns result. grep "CTL-07" FAT-Automatisch-Hek.md confirms timeout test included.
  </verify>
  <done>
Section 5 contains all 7 CTL requirements with specific preconditions, actions, and expected results emphasizing edge detection.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Timer Behavior test section</name>
  <files>FAT-Automatisch-Hek.md</files>
  <action>
Append Section 6: Timer Behavior Tests to FAT-Automatisch-Hek.md

Create table with columns: Test ID | Timer Parameter | Trigger | Duur | Verificatie Methode | Pass/Fail | Opmerkingen

**Timer Tests (TMR-01 through TMR-08):**

TMR-01 (Start low speed timer):
- TMR-01a: Start movement from IDLE, observe q_MS_LaagToeren active
- TMR-01b: Timer duration = CFG_LaagToerenMs = 5 seconds
- TMR-01c: After 5s, q_MS_LaagToeren deactivates (normal speed)

TMR-02 (PBV pause timer):
- TMR-02a: Trigger PBV during movement
- TMR-02b: Motor stops, wait 500ms (CFG_PBV_PauzeMs)
- TMR-02c: After pause, motor starts OPEN direction

TMR-03 (PBV retract timer):
- TMR-03a: After PBV pause, motor moves OPEN
- TMR-03b: Movement duration max CFG_PBV_TerugtrekMs = 3 seconds
- TMR-03c: Timer or BNS_Open reached (whichever first) -> stop

TMR-04 (VS resume delay):
- TMR-04a: Block beam during movement -> VS_PAUSE
- TMR-04b: Unblock beam, wait CFG_VS_HervattingMs = 2 seconds
- TMR-04c: After delay, movement resumes

TMR-05 (VS low speed after resume):
- TMR-05a: After VS resume delay, movement starts at low speed
- TMR-05b: q_MS_LaagToeren active for CFG_VS_LaagToerenMs = 2 seconds
- TMR-05c: After 2s, normal speed resumes

TMR-06 (Movement timeout):
- TMR-06a: Start movement, do not reach endstop
- TMR-06b: After CFG_BewegingTimeoutS = 90 seconds, motor stops
- TMR-06c: State becomes STOPPED, key release required (CTL-07)

TMR-07 (Timer pause on stop, resume on restart):
- TMR-07a: Start movement, wait 2s, press stop button
- TMR-07b: Timer pauses at 2s accumulated
- TMR-07c: Resume movement, timer continues from 2s
- TMR-07d: Total 5s reached, low speed deactivates

TMR-08 (Timer reset on direction change or endstop):
- TMR-08a: Start OPEN, wait 3s, key DICHT -> timer resets to 0
- TMR-08b: New movement starts with fresh 5s low speed timer
- TMR-08c: Reach endstop -> timer resets for next movement

Include actual timer values from DB_Config:
- CFG_LaagToerenMs = 5000ms (5s)
- CFG_PBV_PauzeMs = 500ms
- CFG_PBV_TerugtrekMs = 3000ms (3s)
- CFG_VS_HervattingMs = 2000ms (2s)
- CFG_VS_LaagToerenMs = 2000ms (2s)
- CFG_BewegingTimeoutS = 90000ms (90s)
  </action>
  <verify>
grep "TMR-01" FAT-Automatisch-Hek.md returns result. grep "90s\|90 seconds" FAT-Automatisch-Hek.md confirms timeout test present.
  </verify>
  <done>
Section 6 contains all 8 TMR requirements with specific timer parameters, trigger conditions, durations, and verification methods.
  </done>
</task>

</tasks>

<verification>
After completion:
1. Section 5 exists with all CTL tests (CTL-01 through CTL-07)
2. Section 6 exists with all TMR tests (TMR-01 through TMR-08)
3. Timer values match DB_Config exactly
4. All tests specify precondition, action, and expected result
5. Edge detection emphasized where applicable
</verification>

<success_criteria>
Requirements covered:
- CTL-01: Key switch OPEN command (momentary, rising edge)
- CTL-02: Key switch DICHT command (momentary, rising edge)
- CTL-03: Push button stop (falling edge, NC sensor)
- CTL-04: Push button resume from STOPPED (last direction)
- CTL-05: Key switch overrides direction from STOPPED
- CTL-06: Opposing key during movement -> STOPPED
- CTL-07: Key release required after timeout
- TMR-01: Start low speed timer (5s)
- TMR-02: PBV pause timer (500ms)
- TMR-03: PBV retract timer (3s)
- TMR-04: VS resume delay (2s)
- TMR-05: VS low speed after resume (2s)
- TMR-06: Movement timeout (90s)
- TMR-07: Timer pause on stop, resume on restart
- TMR-08: Timer reset on direction change or endstop
</success_criteria>

<output>
After completion, create `.planning/phases/05-fat-document/05-02-SUMMARY.md`
</output>
